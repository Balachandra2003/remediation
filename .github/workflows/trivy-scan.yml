name: Trivy Scan & Approval Workflow

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # FIXED: Install Trivy without running the action’s default scan
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb stable main | sudo tee -a /etc/apt/sources.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan base images
        run: |
          trivy image --exit-code 0 --format json ubuntu:18.04 > ubuntu.json
          trivy image --exit-code 0 --format json python:3.8 > python.json
          trivy image --exit-code 0 --format json nginx:1.19 > nginx.json

      - name: Count ALL vulnerabilities (ANY severity)
        id: analyze
        run: |
          total=0
          for file in ubuntu.json python.json nginx.json; do
            count=$(jq '[.Results[].Vulnerabilities // []] | flatten | length' "$file")
            total=$((total + count))
          done
          echo "total=$total" >> $GITHUB_OUTPUT

      - name: Send approval email (ANY CVE triggers)
        if: steps.analyze.outputs.total != '0'
        run: python3 scripts/send_email.py "${{ github.run_id }}" "my-org/remediation" "${{ secrets.DISPATCH_TOKEN }}"

      - name: No vulnerabilities → Normal Deploy
        if: steps.analyze.outputs.total == '0'
        run: echo "No vulnerabilities found"
